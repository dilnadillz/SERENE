<%- include('../layouts/header.ejs') %>

    <!-- BREADCRUMB -->
    <nav class="py-5">
      <div class="container">
        <div class="row">
          <div class="col-12">

            <!-- Breadcrumb -->
            <ol class="breadcrumb mb-0 fs-xs text-gray-400">
              <li class="breadcrumb-item">
                <a class="text-gray-400" href="/">Home</a>
              </li>
              <li class="breadcrumb-item active">
                My Account
              </li>
            </ol>

          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENT -->
    <section class="pt-7 pb-12">
      <div  class="container">
        <div class="row">
          <div class="col-12 text-center">

            <!-- Heading -->
            <h3 class="mb-10">My Account</h3>

          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-3">

            <!-- Nav -->
            <nav class="mb-10 mb-md-0">
              <div class="list-group list-group-sm list-group-strong list-group-flush-x">
                <a class="list-group-item list-group-item-action dropend-toggle active" href="/orders">
                  Orders
                </a>
                <a class="list-group-item list-group-item-action dropend-toggle " href="/wishlist">
                  Wishlist
                </a>
                <a class="list-group-item list-group-item-action dropend-toggle " href="/account-personal-info">
                  Personal Info
                </a>
                <a class="list-group-item list-group-item-action dropend-toggle " href="/account-address">
                  Addresses
                </a>
                <a class="list-group-item list-group-item-action dropend-toggle " href="/wallet">
                  Wallet
                </a>
                <a class="list-group-item list-group-item-action dropend-toggle " href="/userReferral">
                  Referral
                </a>
                <a class="list-group-item list-group-item-action dropend-toggle" href="/logout">
                  Logout
                </a>
              </div>
            </nav>

          </div>
          
          <divid="refreshDiv" class="col-12 col-md-9 col-lg-8 offset-lg-1">
            <% orderData.forEach(order => { %>
            <!-- Order -->
            <div class="card card-lg mb-5 border">
              <div class="card-body pb-0">

                <!-- Info -->
                <div  class="card card-sm">
                  <div class="card-body bg-light">
                    
                    <div  class="row">
                      <div class="col-6 col-lg-2">
                          <!-- Heading -->
                          <h6 class="heading-xxxs text-muted">Order No:</h6>
                          <!-- Text -->
                          <p class="mb-lg-0 fs-sm fw-bold">
                              <%= order._id.toString().slice(-6) %>
                          </p>
                      </div>
                      <div class="col-6 col-lg-2">
                          <!-- Heading -->
                          <h6 class="heading-xxxs text-muted">Shipped date:</h6>
                          <!-- Text -->
                          <p class="mb-lg-0 fs-sm fw-bold">
                              <time datetime="<%= order.date %>">
                                  <%= order.date.toLocaleDateString() %>
                              </time>
                          </p>
                      </div>
                      <div class="col-6 col-lg-2">
                          <!-- Heading -->
                          <h6 class="heading-xxxs text-muted">Order Amount:</h6>
                          <!-- Text -->
                          <p class="mb-0 fs-sm fw-bold">
                              <%= order.total_amount %>
                          </p>
                      </div>
                      <div class="col-6 col-lg-2">
                          <!-- Heading -->
                          <h6 class="heading-xxxs text-muted">Quantity:</h6>
                          <!-- Text -->
                          
                          <p class="mb-0 fs-sm fw-bold">
                            <% let totalQuantity = 0; %>
                            <% order.details.forEach(detail => { %>
                              <% totalQuantity += detail.quantity; %>
                            <% }); %>
                            <%= totalQuantity %>
                          </p>
                      </div>
                      <div class="col-6 col-lg-2">
                          <!-- Heading -->
                          <h6 class="heading-xxxs text-muted">Payment Method:</h6>
                          <!-- Text -->
                          <p class="mb-0 fs-sm fw-bold">
                              <%= order.payment %>
                          </p>
                      </div>
                      <div  class="col-6 col-lg-2">
                          <!-- Heading -->
                          <h6 class="heading-xxxs text-muted">Status:</h6>
                          <!-- Text -->
                          <p class="mb-0 fs-sm fw-bold" id="cancel" >
                              <%= order.details[0].status %>
                          </p>

                      


                          <% if (order.details[0].returnStatus === 'return'|| order.details[0].returnStatus === 'Delivered') { %>
                            <p style="color: rgb(218, 162, 8); ">Return request send</p>
                        <% } else if (order.details[0].returnStatus === 'accepted' ) { %>
                            <p style="color: rgb(58, 146, 37);"> Return Accepted</p>
                        <% } else if (order.details[0].returnStatus === 'rejected' ) { %>
                            <p style="color: red;">Return Rejected</p>
                        <% } %> 


              
                      </div>
                      <div class="col-12 col-lg-12 text-lg-end">
                        <% if (order.details[0].status === 'Pending') { %>
                          <!-- Button to retry payment -->
                          <button onclick="retryPayment('<%= order._id %>')">Retry Payment</button>
                      <% } %>
                    </div>
                   
                  </div>
                  
                  </div>
                </div>

              </div>
              <div class="card-footer">
                <div class="row align-items-center">
                  <ul class="list-group list-group-flush">
                    <% order.details.forEach(detail => { %>
                    <li class="list-group-item">
                      <div class="row align-items-center">
                        <div class="col-4 col-md-3 col-xl-2"> 
                          <!-- Product Image -->
                          <% if (Array.isArray(detail.productImage) && detail.productImage.length > 0) { %>
                            <img src="<%= detail.productImage[0] %>" alt="Product Image" class="img-fluid">
                        <% } else { %>
                            <p>No image available</p>
                        <% } %>
                         
                        
                      </div>
                      
                      
                        
                        <div class="col">
                          <!-- Product Details -->
                          <p class="mb-4 fs-sm fw-bold">
                            <a class="text-body" href="/product/<%= detail.productId.productName %>"><%= detail.productName %></a> <br>
                            <span class="text-muted">Quantity: <%= detail.quantity %></span> <br>
                            <span class="text-muted">Price: <%= detail.price %></span>
                          </p>
                        </div>
                      </div>
                    </li>
                    <% }); %>
                  </ul>
                  <div class="col-12 col-lg-6">
                    <div class="row gx-5">
                    
                
                      <div class="col-6">

                        <!-- Button -->
                        <a class="btn btn-sm w-100 btn-outline-dark" href="/orderview?orderId=<%= order._id %>&productId=<%= order.details[0].productId %>">
                          Order Details
                        </a> 
                       
                      </div>
                      <div class="col-6">

                        <% if (order.details[0].status === 'Delivered') { %>
                           <!-- Return Button -->
                           <a class="btn btn-sm w-100 btn-outline-dark"  href="#" onclick="showReturnReasonPrompt('<%= order._id %>', '<%= order.details[0].productId %>')">
                            Return
                          </a>
                                 
                    
                          <% } %>

                       
                          <%  if (order.details[0].status === 'Pending' || order.details[0].status === 'Shipped'|| order.details[0].status === 'Placed') { %>
                          <!-- Cancel Button -->
                          <a class="btn btn-sm w-100 btn-outline-dark cancel-order-btn" href="#" data-order-id="<%= order._id %>" data-product-id="<%= order.details[0].productId %>">
                            Cancel order
                          </a>
                        <% } %>
                        
                      
                         <!-- <butto  class="btn btn-sm w-100 btn-outline-dark cancel-order-btn">Cancel order</button> -->
                        

                      </div>

                      
                    </div>

                  </div>
                </div>
              </div>
            </div>



           
            <% }); %>




<nav class="d-flex justify-content-center justify-content-md-end">
  <ul class="pagination pagination-sm text-gray-400">
      <% if (currentPage > 1) { %>
          <li class="page-item">
              <a class="page-link page-link-arrow" href="?page=<%= currentPage - 1 %>">
                  <i class="fa fa-caret-left"></i>
              </a>
          </li>
      <% } %>
      <% for (let page = 1; page <= totalPages; page++) { %>
          <li class="page-item <%= currentPage === page ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= page %>"><%= page %></a>
          </li>
      <% } %>
      <% if (currentPage < totalPages) { %>
          <li class="page-item">
              <a class="page-link page-link-arrow" href="?page=<%= currentPage + 1 %>">
                  <i class="fa fa-caret-right"></i>
              </a>
          </li>
      <% } %>
  </ul>
</nav>


          </div>
        </div>
      </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




    <script>
      document.addEventListener('DOMContentLoaded', function() {
    const cancelOrderButtons = document.querySelectorAll('.cancel-order-btn');
    cancelOrderButtons.forEach(function(button) {
      console.log("coming")
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const orderId = button.getAttribute('data-order-id');
            const productId = button.getAttribute('data-product-id'); 
            console.log("orderIdjhj",orderId);
            console.log("productId",productId)
            cancelOrder(orderId, productId);
          
        });
    });  

    async function cancelOrder(orderId, productId) {
    try {
        const confirmation = await Swal.fire({
            title: 'Are you sure?',
            text: 'Do you really want to cancel this order?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, cancel it!',
            cancelButtonText: 'No, keep it'
        });

        if (confirmation.isConfirmed) {
            const response = await fetch(`/cancel-order`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ orderId: orderId, productId: productId })
            });

            if (response.ok) {
                const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);

              
                Swal.fire('Cancelled!', 'Your order has been cancelled.', 'success').then(() => {
                 
                 
                    window.location.reload = '/orders';
                });
            } else {
                console.error('Failed to cancel order:', response.statusText);
            }
        }
    } catch (error) {
        console.error('Failed to cancel order:', error.message);
    }
}

});


function showReturnReasonPrompt(orderId, productId) {
    Swal.fire({
        title: 'Return Reason',
        input: 'text',
        inputPlaceholder: 'Enter your return reason here',
        showCancelButton: true,
        confirmButtonText: 'Submit',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
            if (!value) {
                return 'You need to write something!';
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const returnReason = result.value;
           
            fetch('/order-return', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ orderId: orderId, productId: productId, returnReason: returnReason })
            }).then(response => {
                if (response.ok) {
                    Swal.fire('Return Request Sent', 'Your return request has been sent.', 'success');
                } else {
                    Swal.fire('Error', 'Failed to send return request.', 'error');
                }
            }).catch(error => {
                console.error('Failed to send return request:', error.message);
            
            });
        }
    });
}





    </script>



<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  function retryPayment(orderId) {
    fetch(`/pendingPay/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(order => {
      var options = {
          key: '<%= razorpayKey %>',
          amount: order.amount,
          currency: order.currency,
          order_id: order.id,
          name: 'SERENE',
          description: 'Order Payment',
          handler: function (response) {
     
            
            console.log("orderId",orderId)
            fetch(`/placingPayment/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderId }),
                })
                .then(response => {
                  console.log("response",response)
                    if (response.ok) {
                      location.reload();
                        console.log('Order status updated successfully');
                    } else {
                        console.error('Failed to update order status:', response.statusText);
                    }
                })
                .catch(error => {
                    console.error('Failed to update order status:', error.message);
                });
          },
          prefill: {
          name: 'User Name',
          email: 'user@example.com',
          contact: '1234567890',
          },
          notes: {
          address: 'User Address',
          },
          theme: {
          color: '#012652', 
          },
        };

        var rzp = new Razorpay(options);
       
        rzp.open();
    })
    .catch(error => {
        console.error('Failed to fetch order details:', error.message);
    });
}

</script>
     

    <%- include('../layouts/footer.ejs') %>